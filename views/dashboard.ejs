<%- include('partials/header') %>
<div class="container mt-4">
  <div class="fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Selamat datang, @<%= user.username %>!</h2>
      <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
        <i class="fas fa-cog"></i> Pengaturan
      </button>
    </div>

    <div class="row mb-4">
      <div class="col-md-6">
        <p class="text-muted">Bagikan link ini:<br>
          <code id="profileLink">https://<%= req.headers.host %>/<%= user.username %></code>
          <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyLink()">
            <i class="fas fa-copy"></i>
          </button>
        </p>
      </div>
      <div class="col-md-6 text-md-end">
        <img src="<%= qrDataUrl %>" alt="QR Code" width="100" class="img-thumbnail rounded">
        <p class="text-muted mt-2">Scan untuk buka profil</p>
      </div>
    </div>

    <!-- Statistik -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3><%= stats.total %></h3>
            <p class="text-muted">Total Pesan</p>
          </div>
        </div>
      </div>
      <% Object.entries(stats.byCategory).forEach(([cat, count]) => { %>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3><%= count %></h3>
            <p class="text-muted"><%= cat === 'umum' ? 'ðŸ’¬ Umum' : cat === 'pujian' ? 'ðŸ’– Pujian' : cat === 'saran' ? 'ðŸ’¡ Saran' : 'â“ Pertanyaan' %></p>
          </div>
        </div>
      </div>
      <% }) %>
    </div>

    <!-- Pesan Terpopuler -->
    <% if (topMessages.length > 0) { %>
    <div class="card mb-4">
      <div class="card-header bg-info text-white">
        <i class="fas fa-star"></i> Pesan Terpopuler
      </div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          <% topMessages.forEach(msg => { %>
          <li class="list-group-item"><%= msg %></li>
          <% }) %>
        </ul>
      </div>
    </div>
    <% } %>

    <!-- Inbox -->
    <div class="card">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <span><i class="fas fa-inbox"></i> Inbox Pesan Anonim</span>
        <form action="/dashboard/clear-all" method="POST" onsubmit="return confirm('Yakin hapus semua pesan?')" class="d-inline">
          <button type="submit" class="btn btn-sm btn-outline-light">
            <i class="fas fa-trash-alt"></i> Hapus Semua
          </button>
        </form>
      </div>
      <div class="card-body">
        <% if (messages.length === 0) { %>
          <p class="text-center text-muted">Belum ada pesan.</p>
        <% } else { %>
          <div class="list-group">
            <% messages.forEach(msg => { %>
              <div class="list-group-item d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                  <div class="fw-bold">
                    <%= msg.category === 'umum' ? 'ðŸ’¬' : msg.category === 'pujian' ? 'ðŸ’–' : msg.category === 'saran' ? 'ðŸ’¡' : 'â“' %>
                  </div>
                  <p class="mb-1"><%= msg.content %></p>
                  <small class="text-muted"><%= msg.createdAt.toLocaleString('id-ID') %></small>
                </div>
                <div>
                  <a href="/<%= user.username %>?reply=<%= msg._id %>" class="btn btn-sm btn-outline-primary me-1">
                    <i class="fas fa-reply"></i>
                  </a>
                  <form action="/dashboard/message/<%= msg._id %>/delete" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Modal Pengaturan -->
<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Pengaturan Profil</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="/dashboard/settings" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label>Bio</label>
            <input type="text" name="bio" class="form-control" value="<%= user.bio %>" maxlength="100">
          </div>
          <div class="mb-3">
            <label>Emoji Profil</label>
            <input type="text" name="emoji" class="form-control" value="<%= user.emoji %>" maxlength="2">
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" name="praiseOnly" class="form-check-input" id="praiseOnly" <%= user.praiseOnly ? 'checked' : '' %>>
            <label class="form-check-label" for="praiseOnly">Mode Hanya Pujian</label>
          </div>
          <div class="mb-3">
            <label>Kata yang Diblokir (pisahkan koma)</label>
            <input type="text" name="blockedWords" class="form-control" 
                   value="<%= user.blockedWords.join(', ') %>">
            <small class="text-muted">Contoh: mantan, PR, ujian</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function copyLink() {
    const text = document.getElementById('profileLink').textContent;
    navigator.clipboard.writeText(text).then(() => {
      const toast = new bootstrap.Toast(document.getElementById('copyToast'));
      toast.show();
    });
  }
</script>

<%- include('partials/footer') %>